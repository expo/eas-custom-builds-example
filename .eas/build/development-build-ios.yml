build:
  name: Simple simulator iOS build
  steps:
    - eas/checkout

    - eas/install_node_modules

    - eas/prebuild

    - run:
        name: Install pods
        working_directory: ./ios
        command: pod install

    - eas/generate_gymfile_from_template

    - eas/run_fastlane

    - eas/find_and_upload_build_artifacts

    - eas/install_maestro:
        inputs:
          maestro_version: 1.35.0

    - eas/start_ios_simulator

    - run:
        name: Install app to running simulator
        command: |
          for APP_PATH in ios/build/Build/Products/*simulator/*.app; do
            xcrun simctl install booted $APP_PATH
          done

    - run:
        name: Run Maestro
        env:
          MAESTRO_DRIVER_STARTUP_TIMEOUT: "120000"
        command: |
          maestro test maestro/flow.yaml

    - eas/upload_artifact:
        name: Upload test artifact
        if: ${ always() }
        inputs:
          type: build-artifact
          path: /Users/expo/.maestro/tests
